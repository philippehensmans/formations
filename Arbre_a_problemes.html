<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbre √† Probl√®mes & Solutions - Vue Arborescente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #000000;
            --secondary: #666666;
            --accent: #1e3a8a;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --border: #e5e5e5;
            --red: #dc2626;
            --orange: #ea580c;
            --amber: #d97706;
            --green: #16a34a;
            --blue: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: var(--bg-main);
            color: var(--primary);
            line-height: 1.6;
            padding: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 32px;
        }

        header {
            margin-bottom: 32px;
            text-align: center;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 24px;
        }

        header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        header p {
            color: var(--secondary);
            font-style: italic;
        }

        .form-group {
            margin-bottom: 24px;
            padding: 20px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }

        .view-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--border);
        }

        .btn-outline.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Vue Arbre */
        .tree-view {
            display: none;
            margin: 40px 0;
            padding: 40px 20px;
            background: linear-gradient(to bottom, #f0f9ff 0%, #ffffff 30%, #ffffff 70%, #fffbeb 100%);
            border-radius: 8px;
            min-height: 800px;
            position: relative;
        }

        .tree-view.active {
            display: block;
        }

        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 60px;
            position: relative;
        }

        /* Cons√©quences (Branches) */
        .consequences-section {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        .tree-node {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            min-width: 200px;
            max-width: 280px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
        }

        .tree-node:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tree-node.consequence {
            border-color: #fecaca;
            background: #fef2f2;
        }

        .tree-node.consequence::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #fecaca;
        }

        .tree-node.central {
            border: 3px solid #fb923c;
            background: #fff7ed;
            min-width: 300px;
            max-width: 400px;
            padding: 24px;
        }

        .tree-node.cause {
            border-color: #fde68a;
            background: #fffbeb;
        }

        .tree-node.cause::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #fde68a;
        }

        .tree-node.objectif {
            border-color: #bbf7d0;
            background: #f0fdf4;
        }

        .tree-node.objectif::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #bbf7d0;
        }

        .tree-node.moyen {
            border-color: #bfdbfe;
            background: #eff6ff;
        }

        .tree-node.moyen::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #bfdbfe;
        }

        .node-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .node-content {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .node-content.editable {
            border: 1px dashed var(--border);
            padding: 8px;
            border-radius: 4px;
            cursor: text;
            min-height: 40px;
        }

        .node-content.editable:hover {
            border-color: var(--accent);
            background: rgba(30, 58, 138, 0.05);
        }

        .node-content.empty {
            color: var(--secondary);
            font-style: italic;
        }

        .central-node {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .add-node-btn {
            background: white;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 16px;
            min-width: 200px;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .add-node-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(30, 58, 138, 0.05);
        }

        .causes-section {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        /* Vue Formulaire */
        .form-view {
            display: none;
        }

        .form-view.active {
            display: block;
        }

        .section {
            margin-bottom: 32px;
            padding: 24px;
            border-radius: 4px;
            border: 2px solid var(--border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .section-consequences {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .section-consequences .section-title {
            color: var(--red);
        }

        .section-central {
            background: #fff7ed;
            border: 3px solid #fb923c;
        }

        .section-central .section-title {
            color: var(--orange);
            text-align: center;
            font-size: 1.5rem;
        }

        .section-causes {
            background: #fffbeb;
            border-color: #fde68a;
        }

        .section-causes .section-title {
            color: var(--amber);
        }

        .section-objectifs {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .section-objectifs .section-title {
            color: var(--green);
        }

        .section-moyens {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .section-moyens .section-title {
            color: var(--blue);
        }

        .btn-red {
            background: var(--red);
            color: white;
        }

        .btn-amber {
            background: var(--amber);
            color: white;
        }

        .btn-green {
            background: var(--green);
            color: white;
        }

        .btn-blue {
            background: var(--blue);
            color: white;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .item-row input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn-remove {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 8px;
        }

        .info-text {
            font-size: 0.9rem;
            color: var(--secondary);
            font-style: italic;
            margin-top: 4px;
        }

        textarea.central-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 32px;
        }

        .tab-button {
            padding: 12px 24px;
            font-weight: 600;
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid var(--border);
        }

        .section-label {
            text-align: center;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid currentColor;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .tree-view {
                background: white;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .tree-node {
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå≥ Analyse du Contexte & Identification des Enjeux</h1>
            <p>M√©thode : Arbre √† Probl√®mes ‚Üí Arbre √† Solutions</p>
        </header>

        <!-- Informations du projet -->
        <div class="form-group">
            <label for="nomProjet">üìã Nom du Projet</label>
            <input 
                type="text" 
                id="nomProjet"
                placeholder="Ex: Am√©lioration de l'acc√®s √† l'eau potable dans la r√©gion X"
                oninput="updateTree()"
            >
        </div>

        <div class="form-group">
            <label for="participants">üë• Groupe / Participants</label>
            <input 
                type="text" 
                id="participants"
                placeholder="Noms des participants du groupe (2-3 personnes)"
            >
        </div>

        <!-- S√©lecteur de vue -->
        <div class="view-toggle no-print">
            <button class="btn btn-outline active" onclick="switchView('tree')">üå≥ Vue Arbre</button>
            <button class="btn btn-outline" onclick="switchView('form')">üìù Vue Formulaire</button>
        </div>

        <!-- Tabs pour Probl√®mes/Solutions -->
        <div class="tabs no-print">
            <button 
                id="tab-problemes" 
                class="tab-button active"
                onclick="switchTab('problemes')"
            >
                üî¥ Arbre √† Probl√®mes
            </button>
            <button 
                id="tab-solutions" 
                class="tab-button"
                onclick="switchTab('solutions')"
            >
                üü¢ Arbre √† Solutions
            </button>
        </div>

        <!-- VUE ARBRE - Arbre √† Probl√®mes -->
        <div id="tree-problemes" class="tree-view active">
            <div class="legend no-print">
                <div class="legend-item">
                    <div class="legend-color" style="background: #fef2f2; color: #fecaca;"></div>
                    <span>Cons√©quences</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff7ed; color: #fb923c;"></div>
                    <span>Probl√®me central</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fffbeb; color: #fde68a;"></div>
                    <span>Causes</span>
                </div>
            </div>

            <div class="tree-container">
                <!-- Cons√©quences (Branches) -->
                <div class="section-label">üåø Cons√©quences (Effets du probl√®me)</div>
                <div class="consequences-section" id="tree-consequences">
                    <button class="add-node-btn" onclick="addConsequence()">
                        ‚ûï Ajouter une cons√©quence
                    </button>
                </div>

                <!-- Probl√®me Central (Tronc) -->
                <div class="tree-node central" onclick="editCentralNode('problemeCentral')">
                    <div class="node-title">üéØ Probl√®me Central</div>
                    <div class="node-content central-node editable" id="tree-problemeCentral">
                        Cliquez pour d√©finir le probl√®me central
                    </div>
                </div>

                <!-- Causes (Racines) -->
                <div class="section-label">üå± Causes (Racines du probl√®me)</div>
                <div class="causes-section" id="tree-causes">
                    <button class="add-node-btn" onclick="addCause()">
                        ‚ûï Ajouter une cause
                    </button>
                </div>
            </div>
        </div>

        <!-- VUE ARBRE - Arbre √† Solutions -->
        <div id="tree-solutions" class="tree-view">
            <div class="legend no-print">
                <div class="legend-item">
                    <div class="legend-color" style="background: #f0fdf4; color: #bbf7d0;"></div>
                    <span>Objectifs</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff7ed; color: #fb923c;"></div>
                    <span>Objectif central</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #eff6ff; color: #bfdbfe;"></div>
                    <span>Moyens</span>
                </div>
            </div>

            <div class="tree-container">
                <!-- Objectifs -->
                <div class="section-label">üéØ Objectifs / Impacts Positifs</div>
                <div class="consequences-section" id="tree-objectifs">
                    <button class="add-node-btn" onclick="addObjectif()">
                        ‚ûï Ajouter un objectif
                    </button>
                </div>

                <!-- Objectif Central -->
                <div class="tree-node central" onclick="editCentralNode('objectifCentral')">
                    <div class="node-title">üéØ Objectif Central</div>
                    <div class="node-content central-node editable" id="tree-objectifCentral">
                        Cliquez pour d√©finir l'objectif central
                    </div>
                </div>

                <!-- Moyens -->
                <div class="section-label">üõ†Ô∏è Moyens / Actions √† Mettre en ≈íuvre</div>
                <div class="causes-section" id="tree-moyens">
                    <button class="add-node-btn" onclick="addMoyen()">
                        ‚ûï Ajouter un moyen
                    </button>
                </div>
            </div>
        </div>

        <!-- VUE FORMULAIRE - Arbre √† Probl√®mes -->
        <div id="form-problemes" class="form-view">
            <div class="section section-consequences">
                <div class="section-header">
                    <div>
                        <div class="section-title">üåø Cons√©quences (Effets)</div>
                        <div class="info-text">Quels sont les impacts n√©gatifs du probl√®me ?</div>
                    </div>
                    <button onclick="addConsequence()" class="btn btn-red">‚ûï Ajouter</button>
                </div>
                <div id="consequencesList" class="item-list"></div>
            </div>

            <div class="section section-central">
                <div class="section-title">üéØ Probl√®me Central</div>
                <div class="info-text" style="text-align: center; margin-bottom: 16px;">Quel est le probl√®me principal ?</div>
                <textarea 
                    id="problemeCentral"
                    rows="3"
                    class="central-input"
                    placeholder="Ex: Acc√®s insuffisant √† l'eau potable"
                    oninput="updateTree()"
                ></textarea>
            </div>

            <div class="section section-causes">
                <div class="section-header">
                    <div>
                        <div class="section-title">üå± Causes (Racines)</div>
                        <div class="info-text">Quelles sont les causes profondes ?</div>
                    </div>
                    <button onclick="addCause()" class="btn btn-amber">‚ûï Ajouter</button>
                </div>
                <div id="causesList" class="item-list"></div>
            </div>
        </div>

        <!-- VUE FORMULAIRE - Arbre √† Solutions -->
        <div id="form-solutions" class="form-view">
            <div class="section section-objectifs">
                <div class="section-header">
                    <div>
                        <div class="section-title">üéØ Objectifs / Impacts Positifs</div>
                        <div class="info-text">R√©sultats positifs souhait√©s</div>
                    </div>
                    <button onclick="addObjectif()" class="btn btn-green">‚ûï Ajouter</button>
                </div>
                <div id="objectifsList" class="item-list"></div>
            </div>

            <div class="section section-central">
                <div class="section-title">üéØ Objectif Central</div>
                <div class="info-text" style="text-align: center; margin-bottom: 16px;">Reformulation positive du probl√®me</div>
                <textarea 
                    id="objectifCentral"
                    rows="3"
                    class="central-input"
                    placeholder="Ex: Garantir un acc√®s durable √† l'eau potable"
                    oninput="updateTree()"
                ></textarea>
            </div>

            <div class="section section-moyens">
                <div class="section-header">
                    <div>
                        <div class="section-title">üõ†Ô∏è Moyens / Actions</div>
                        <div class="info-text">Actions concr√®tes √† mettre en ≈ìuvre</div>
                    </div>
                    <button onclick="addMoyen()" class="btn btn-blue">‚ûï Ajouter</button>
                </div>
                <div id="moyensList" class="item-list"></div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions no-print">
            <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Imprimer / PDF</button>
            <button onclick="exportJSON()" class="btn btn-outline">üíæ Exporter JSON</button>
            <button onclick="exportToExcel()" class="btn btn-outline">üìä Exporter Excel</button>
            <button onclick="resetForm()" class="btn btn-outline">üîÑ R√©initialiser</button>
        </div>
    </div>

    <script>
        let currentView = 'tree';
        let currentTab = 'problemes';
        let data = {
            consequences: [],
            causes: [],
            objectifs: [],
            moyens: []
        };

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (view === 'tree') {
                document.getElementById('tree-' + currentTab).style.display = 'block';
                document.getElementById('form-' + currentTab).classList.remove('active');
            } else {
                document.getElementById('tree-' + currentTab).style.display = 'none';
                document.getElementById('form-' + currentTab).classList.add('active');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('tab-' + tab).classList.add('active');

            // Hide all views
            document.querySelectorAll('.tree-view, .form-view').forEach(view => {
                view.style.display = 'none';
                view.classList.remove('active');
            });

            // Show current view
            if (currentView === 'tree') {
                document.getElementById('tree-' + tab).style.display = 'block';
                document.getElementById('tree-' + tab).classList.add('active');
            } else {
                document.getElementById('form-' + tab).classList.add('active');
            }
        }

        function editCentralNode(id) {
            const content = document.getElementById('tree-' + id);
            const currentText = document.getElementById(id).value;
            
            const newText = prompt('Modifier le texte:', currentText);
            if (newText !== null) {
                document.getElementById(id).value = newText;
                updateTree();
            }
        }

        function updateTree() {
            // Update probl√®me central
            const problemeCentral = document.getElementById('problemeCentral').value;
            const treeProblemeCentral = document.getElementById('tree-problemeCentral');
            if (problemeCentral) {
                treeProblemeCentral.textContent = problemeCentral;
                treeProblemeCentral.classList.remove('empty');
            } else {
                treeProblemeCentral.textContent = 'Cliquez pour d√©finir le probl√®me central';
                treeProblemeCentral.classList.add('empty');
            }

            // Update objectif central
            const objectifCentral = document.getElementById('objectifCentral').value;
            const treeObjectifCentral = document.getElementById('tree-objectifCentral');
            if (objectifCentral) {
                treeObjectifCentral.textContent = objectifCentral;
                treeObjectifCentral.classList.remove('empty');
            } else {
                treeObjectifCentral.textContent = 'Cliquez pour d√©finir l\'objectif central';
                treeObjectifCentral.classList.add('empty');
            }

            renderTreeNodes();
            saveToLocalStorage();
        }

        function renderTreeNodes() {
            // Render consequences
            const treeConsequences = document.getElementById('tree-consequences');
            treeConsequences.innerHTML = '';
            data.consequences.forEach((text, index) => {
                if (text.trim()) {
                    const node = createTreeNode(text, 'consequence', index, 'consequences');
                    treeConsequences.appendChild(node);
                }
            });
            const addBtn = document.createElement('button');
            addBtn.className = 'add-node-btn';
            addBtn.textContent = '‚ûï Ajouter une cons√©quence';
            addBtn.onclick = addConsequence;
            treeConsequences.appendChild(addBtn);

            // Render causes
            const treeCauses = document.getElementById('tree-causes');
            treeCauses.innerHTML = '';
            data.causes.forEach((text, index) => {
                if (text.trim()) {
                    const node = createTreeNode(text, 'cause', index, 'causes');
                    treeCauses.appendChild(node);
                }
            });
            const addBtn2 = document.createElement('button');
            addBtn2.className = 'add-node-btn';
            addBtn2.textContent = '‚ûï Ajouter une cause';
            addBtn2.onclick = addCause;
            treeCauses.appendChild(addBtn2);

            // Render objectifs
            const treeObjectifs = document.getElementById('tree-objectifs');
            treeObjectifs.innerHTML = '';
            data.objectifs.forEach((text, index) => {
                if (text.trim()) {
                    const node = createTreeNode(text, 'objectif', index, 'objectifs');
                    treeObjectifs.appendChild(node);
                }
            });
            const addBtn3 = document.createElement('button');
            addBtn3.className = 'add-node-btn';
            addBtn3.textContent = '‚ûï Ajouter un objectif';
            addBtn3.onclick = addObjectif;
            treeObjectifs.appendChild(addBtn3);

            // Render moyens
            const treeMoyens = document.getElementById('tree-moyens');
            treeMoyens.innerHTML = '';
            data.moyens.forEach((text, index) => {
                if (text.trim()) {
                    const node = createTreeNode(text, 'moyen', index, 'moyens');
                    treeMoyens.appendChild(node);
                }
            });
            const addBtn4 = document.createElement('button');
            addBtn4.className = 'add-node-btn';
            addBtn4.textContent = '‚ûï Ajouter un moyen';
            addBtn4.onclick = addMoyen;
            treeMoyens.appendChild(addBtn4);
        }

        function createTreeNode(text, type, index, dataKey) {
            const node = document.createElement('div');
            node.className = `tree-node ${type}`;
            
            const content = document.createElement('div');
            content.className = 'node-content editable';
            content.textContent = text;
            content.onclick = () => editNode(dataKey, index);
            
            node.appendChild(content);
            
            // Add delete button (visible on hover in CSS would be better, but for simplicity)
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '√ó';
            deleteBtn.className = 'btn-remove';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '4px';
            deleteBtn.style.right = '4px';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteNode(dataKey, index);
            };
            node.appendChild(deleteBtn);
            node.style.position = 'relative';
            
            return node;
        }

        function editNode(dataKey, index) {
            const newText = prompt('Modifier le texte:', data[dataKey][index]);
            if (newText !== null) {
                data[dataKey][index] = newText;
                updateTree();
                updateFormLists();
            }
        }

        function deleteNode(dataKey, index) {
            if (confirm('Supprimer cet √©l√©ment ?')) {
                data[dataKey].splice(index, 1);
                updateTree();
                updateFormLists();
            }
        }

        function addConsequence() {
            const text = prompt('Nouvelle cons√©quence:');
            if (text && text.trim()) {
                data.consequences.push(text);
                updateTree();
                updateFormLists();
            }
        }

        function addCause() {
            const text = prompt('Nouvelle cause:');
            if (text && text.trim()) {
                data.causes.push(text);
                updateTree();
                updateFormLists();
            }
        }

        function addObjectif() {
            const text = prompt('Nouvel objectif:');
            if (text && text.trim()) {
                data.objectifs.push(text);
                updateTree();
                updateFormLists();
            }
        }

        function addMoyen() {
            const text = prompt('Nouveau moyen:');
            if (text && text.trim()) {
                data.moyens.push(text);
                updateTree();
                updateFormLists();
            }
        }

        function updateFormLists() {
            // Update consequences list
            const consequencesList = document.getElementById('consequencesList');
            consequencesList.innerHTML = '';
            data.consequences.forEach((text, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" value="${text}" onchange="data.consequences[${index}] = this.value; updateTree()">
                    <button type="button" onclick="data.consequences.splice(${index}, 1); updateTree(); updateFormLists()" class="btn-remove">‚ùå</button>
                `;
                consequencesList.appendChild(div);
            });

            // Update causes list
            const causesList = document.getElementById('causesList');
            causesList.innerHTML = '';
            data.causes.forEach((text, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" value="${text}" onchange="data.causes[${index}] = this.value; updateTree()">
                    <button type="button" onclick="data.causes.splice(${index}, 1); updateTree(); updateFormLists()" class="btn-remove">‚ùå</button>
                `;
                causesList.appendChild(div);
            });

            // Update objectifs list
            const objectifsList = document.getElementById('objectifsList');
            objectifsList.innerHTML = '';
            data.objectifs.forEach((text, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" value="${text}" onchange="data.objectifs[${index}] = this.value; updateTree()">
                    <button type="button" onclick="data.objectifs.splice(${index}, 1); updateTree(); updateFormLists()" class="btn-remove">‚ùå</button>
                `;
                objectifsList.appendChild(div);
            });

            // Update moyens list
            const moyensList = document.getElementById('moyensList');
            moyensList.innerHTML = '';
            data.moyens.forEach((text, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" value="${text}" onchange="data.moyens[${index}] = this.value; updateTree()">
                    <button type="button" onclick="data.moyens.splice(${index}, 1); updateTree(); updateFormLists()" class="btn-remove">‚ùå</button>
                `;
                moyensList.appendChild(div);
            });

            saveToLocalStorage();
        }

        function saveToLocalStorage() {
            const saveData = {
                nomProjet: document.getElementById('nomProjet').value,
                participants: document.getElementById('participants').value,
                problemeCentral: document.getElementById('problemeCentral').value,
                objectifCentral: document.getElementById('objectifCentral').value,
                consequences: data.consequences,
                causes: data.causes,
                objectifs: data.objectifs,
                moyens: data.moyens
            };
            localStorage.setItem('arbreProblemes', JSON.stringify(saveData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('arbreProblemes');
            if (saved) {
                const saveData = JSON.parse(saved);
                document.getElementById('nomProjet').value = saveData.nomProjet || '';
                document.getElementById('participants').value = saveData.participants || '';
                document.getElementById('problemeCentral').value = saveData.problemeCentral || '';
                document.getElementById('objectifCentral').value = saveData.objectifCentral || '';
                data.consequences = saveData.consequences || [];
                data.causes = saveData.causes || [];
                data.objectifs = saveData.objectifs || [];
                data.moyens = saveData.moyens || [];
                updateTree();
                updateFormLists();
            }
        }

        function exportJSON() {
            const formData = {
                nomProjet: document.getElementById('nomProjet').value,
                participants: document.getElementById('participants').value,
                arbreProblemes: {
                    problemeCentral: document.getElementById('problemeCentral').value,
                    consequences: data.consequences,
                    causes: data.causes
                },
                arbreSolutions: {
                    objectifCentral: document.getElementById('objectifCentral').value,
                    objectifs: data.objectifs,
                    moyens: data.moyens
                },
                dateExport: new Date().toISOString()
            };

            const dataStr = JSON.stringify(formData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const nomFichier = formData.nomProjet ? 
                formData.nomProjet.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 
                'arbre_problemes';
            link.download = `${nomFichier}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            const infoData = [
                ['üå≥ ANALYSE DU CONTEXTE - ARBRE √Ä PROBL√àMES & SOLUTIONS'],
                [''],
                ['Projet', document.getElementById('nomProjet').value],
                ['Participants', document.getElementById('participants').value],
                ['Date d\'export', new Date().toLocaleDateString('fr-FR')]
            ];

            const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
            wsInfo['!cols'] = [{ wch: 20 }, { wch: 80 }];

            const problemesData = [
                ['üî¥ ARBRE √Ä PROBL√àMES'],
                [''],
                ['PROBL√àME CENTRAL'],
                [document.getElementById('problemeCentral').value],
                [''],
                ['CONS√âQUENCES (Effets n√©gatifs)']
            ];

            data.consequences.forEach((c, i) => {
                problemesData.push([`${i + 1}.`, c]);
            });

            problemesData.push(['']);
            problemesData.push(['CAUSES (Racines du probl√®me)']);

            data.causes.forEach((c, i) => {
                problemesData.push([`${i + 1}.`, c]);
            });

            const wsProblemes = XLSX.utils.aoa_to_sheet(problemesData);
            wsProblemes['!cols'] = [{ wch: 5 }, { wch: 80 }];

            const solutionsData = [
                ['üü¢ ARBRE √Ä SOLUTIONS'],
                [''],
                ['OBJECTIF CENTRAL'],
                [document.getElementById('objectifCentral').value],
                [''],
                ['OBJECTIFS / IMPACTS POSITIFS']
            ];

            data.objectifs.forEach((o, i) => {
                solutionsData.push([`${i + 1}.`, o]);
            });

            solutionsData.push(['']);
            solutionsData.push(['MOYENS / ACTIONS √Ä METTRE EN ≈íUVRE']);

            data.moyens.forEach((m, i) => {
                solutionsData.push([`${i + 1}.`, m]);
            });

            const wsSolutions = XLSX.utils.aoa_to_sheet(solutionsData);
            wsSolutions['!cols'] = [{ wch: 5 }, { wch: 80 }];

            XLSX.utils.book_append_sheet(wb, wsInfo, 'Informations');
            XLSX.utils.book_append_sheet(wb, wsProblemes, 'Arbre √† Probl√®mes');
            XLSX.utils.book_append_sheet(wb, wsSolutions, 'Arbre √† Solutions');

            const nomProjet = document.getElementById('nomProjet').value || 'projet';
            const filename = `arbre_${nomProjet.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function resetForm() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) {
                document.getElementById('nomProjet').value = '';
                document.getElementById('participants').value = '';
                document.getElementById('problemeCentral').value = '';
                document.getElementById('objectifCentral').value = '';
                data = {
                    consequences: [],
                    causes: [],
                    objectifs: [],
                    moyens: []
                };
                localStorage.removeItem('arbreProblemes');
                updateTree();
                updateFormLists();
            }
        }

        // Initialize on load
        window.addEventListener('load', function() {
            loadFromLocalStorage();
        });
    </script>
</body>
</html>